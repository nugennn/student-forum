{% extends 'profile/base.html' %} {# This line was in your provided code, keeping it #}
{% load qa_tags %}
{% load static %} {# Added missing load static tag if needed by base.html #}
{% load humanize %} {# Added missing load humanize tag if needed #}


{% block css %} {# Start CSS Block for styles specific to this page #}

{# Basic Stacks CSS needed for layout components #}
<link rel="stylesheet" type="text/css" href="https://cdn.sstatic.net/Shared/stacks.css?v=556e4333f24c">
<link rel="stylesheet" type="text/css" href="https://cdn.sstatic.net/Sites/stackoverflow/primary.css?v=34c234f84be8">
<link rel="stylesheet" type="text/css" href="https://cdn.sstatic.net/Sites/stackoverflow/secondary.css?v=bbf1061b903d">
<link rel="stylesheet" type="text/css" href="https://cdn.sstatic.net/Shared/Channels/channels.css?v=47a5e0f03c81">


<style>
    /* --- Base Variables and Body Style (Consistent) --- */
    :root {
      --primary: #6366f1;
      --primary-light: #818cf8;
      --primary-dark: #4f46e5;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --bg-primary: #ffffff;
      --bg-secondary: #f1f5f9; /* Consistent background */
      --border: #e2e8f0;
      --hover: #f1f5f9; /* Use light gray for hover */
    }

    /* --- Main Content Area --- */
    #content { 
        background-color: var(--bg-secondary); 
        min-height: calc(100vh - 100px);
    }
    #mainbar-full { padding: 24px; flex-grow: 1; min-width: 0; }
    .fs-headline1 { font-size: 32px; font-weight: 700; color: var(--text-primary); letter-spacing: -0.5px; }
    .fs-body2 { font-size: 15px; color: var(--text-secondary); line-height: 1.6; }

    /* --- Search Input --- */
    .ps-relative {
        position: relative;
    }
    .s-input__search {
        border-radius: 6px !important; 
        border: 1px solid var(--border) !important;
        font-size: 14px !important; 
        padding-left: 40px !important; /* Space for icon */
        padding-right: 12px !important;
        padding-top: 10px !important;
        padding-bottom: 10px !important;
        height: 42px !important;
        width: 100% !important;
        max-width: 300px;
    }
    .s-input__search:focus { 
        border-color: var(--primary) !important; 
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2) !important; 
        outline: none;
    }
    .s-input-icon__search { 
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        fill: var(--text-secondary); 
        height: 18px; 
        width: 18px;
        pointer-events: none;
    }

    /* --- Filter Button Group (Popular, Name, New) --- */
    .s-btn-group { gap: 0px !important; border-radius: 8px; overflow: hidden; display: inline-flex; }
    .s-btn-group .s-btn__muted {
        border: 1px solid var(--border) !important; background: white !important;
        color: var(--text-secondary) !important; padding: 6px 14px !important; /* Adjusted size */
        font-size: 14px !important; font-weight: 500 !important;
        transition: all 0.2s !important; margin: 0 !important; border-radius: 0 !important;
    }
    .s-btn-group .s-btn__muted:hover { border-color: var(--primary) !important; color: var(--primary) !important; }
    .s-btn-group .is-selected { background: var(--primary) !important; color: white !important; border-color: var(--primary) !important; z-index: 2; }
    .s-btn-group > .s-btn__muted:first-child { border-top-left-radius: 8px !important; border-bottom-left-radius: 8px !important; }
    .s-btn-group > .s-btn__muted:last-child { border-top-right-radius: 8px !important; border-bottom-right-radius: 8px !important; }
    .s-btn-group > .s-btn__muted:not(:first-child) { border-left-width: 0 !important; }

    /* --- Tag Card Styles --- */
    .s-card.js-tag-cell {
        background: var(--bg-primary) !important; border: 1px solid var(--border) !important;
        border-radius: 12px !important; padding: 20px !important;
        margin-bottom: 0 !important; transition: all 0.3s ease-out !important;
        display: flex !important; flex-direction: column !important; height: 100%;
        cursor: pointer;
    }
    .s-card.js-tag-cell:hover {
        border-color: var(--primary) !important; 
        box-shadow: 0 8px 24px rgba(99, 102, 241, 0.2) !important;
        transform: translateY(-4px);
    }
    .tag-icon {
        display: inline-block;
        line-height: 1;
        transition: transform 0.3s ease;
    }
    .s-card.js-tag-cell:hover .tag-icon {
        transform: scale(1.2) rotate(5deg);
    }
    .gap-8 { gap: 8px; }
    .s-card .post-tag {
        padding: 6px 12px !important;
        border-radius: 8px !important; font-size: 14px !important;
        font-weight: 600 !important; transition: all 0.3s !important;
        text-decoration: none !important; display: inline-block;
        border: 2px solid !important;
    }
    .s-card .post-tag:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .s-card .tag-description {
        color: var(--text-secondary); font-size: 14px; line-height: 1.6;
        min-height: 42px; /* Ensure consistent card heights */
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .s-card .fs-caption { font-size: 13px; color: var(--text-secondary); }
    .s-card .fs-caption strong { color: var(--primary); font-weight: 600; }
    .s-card .s-anchors a { color: var(--primary) !important; text-decoration: none; }
    .s-card .s-anchors a:hover { text-decoration: underline; }

     /* Grid layout for tags */
     #tags-browser.d-grid {
         grid-template-columns: repeat(4, 1fr); /* Default 4 columns */
     }
     @media (max-width: 1200px) { /* lg breakpoint approx */
         #tags-browser.d-grid { grid-template-columns: repeat(3, 1fr); }
     }
     @media (max-width: 980px) { /* md breakpoint approx */
         #tags-browser.d-grid { grid-template-columns: repeat(2, 1fr); }
     }
      @media (max-width: 640px) { /* sm breakpoint approx */
         #tags-browser.d-grid { grid-template-columns: repeat(1, 1fr); }
     }


    /* --- Footer Style (If needed, assuming base.html provides it) --- */
    /* If base.html includes the footer, these are not needed here */
    /*
    #footer.site-footer { ... }
    .site-footer--container { ... }
    */

</style>
{% endblock css %}


{% block content %} {# Start the main content block #}

{# --- Main Content --- #}
<div id="content" class="snippet-hidden" style="width: 100%; max-width: 1400px; margin: 0 auto; padding: 24px;">
        <div id="mainbar-full">
            <h1 class="fs-headline1 mb16">
                Tags
            </h1>
            <p class="fs-body2 wmx6 mb16">
                A tag is a keyword or label that categorizes your question with other, similar questions. Using the right tags makes it easier for others to find and answer your question.
            </p>

            <div class="d-flex flex-wrap jc-space-between ai-center mb16"> {# Use flex-wrap and space-between #}
                <div class="flex--item ps-relative mb12 mr16"> {# Add margin-right #}
                    <input name="w" id="id_search_user" class="s-input s-input__search" autocomplete="off" type="text" maxlength="35" placeholder="Filter by tag name" autofocus>
                    <svg aria-hidden="true" class="s-input-icon s-input-icon__search svg-icon iconSearch" width="18" height="18" viewBox="0 0 18 18"><path d="m18 16.5-5.14-5.18h-.35a7 7 0 10-1.19 1.19v.35L16.5 18l1.5-1.5ZM12 7A5 5 0 112 7a5 5 0 0110 0Z"/></svg>
                </div>
                <div class="flex--item mb12 d-flex s-btn-group js-filter-btn">
                    {# Assuming 'tab' is passed in context to determine active state #}
                    <a class="{% if tab == 'popular' or not tab %}is-selected{% endif %} flex--item s-btn s-btn__muted s-btn__outlined" href="{% url 'profile:tagsPage' %}?tab=popular" title="most popular tags">Popular</a>
                    <a class="{% if tab == 'name' %}is-selected{% endif %} flex--item s-btn s-btn__muted s-btn__outlined" href="{% url 'profile:tagsPage' %}?tab=name" title="tags in alphabetical order">Name</a>
                    <a class="{% if tab == 'new' %}is-selected{% endif %} flex--item s-btn s-btn__muted s-btn__outlined" href="{% url 'profile:tagsPage' %}?tab=new" title="recently created tags">New</a>
                </div>
            </div>

            <div id="tags_list">
                <div id="tags-browser" class="d-grid g12 loopedTags"> {# Removed grid__* classes, handled by CSS media queries #}
                    {% for tag in All_tags %}
                        <div class="s-card js-tag-cell d-flex fd-column mySearchedTags" data-tag-name="{{ tag.name|lower }}">
                            <div class="d-flex jc-space-between ai-center mb12">
                                <div class="flex--item d-flex ai-center gap-8">
                                    <span class="tag-icon" style="font-size: 24px;">{{ tag.icon }}</span>
                                    <a href="{% url 'tagbadge:taggedItemsFrom_All' tag.id %}" 
                                       class="post-tag" 
                                       style="background-color: {{ tag.color }}15; border-color: {{ tag.color }}50; color: {{ tag.color }};"
                                       title="show questions tagged '{{ tag.name }}'" 
                                       rel="tag">{{ tag.name }}</a>
                                </div>
                            </div>
                            <div class="flex--item fc-medium mb12 tag-description">
                                {{ tag.description }}
                            </div>
                            <div class="mt-auto d-flex jc-space-between fs-caption fc-black-400">
                                <div class="flex--item">
                                    <strong>{{ tag.question_count }}</strong> question{{ tag.question_count|pluralize }}
                                </div>
                                <div class="flex--item s-anchors s-anchors__inherit"></div>
                            </div>
                        </div>
                    {% empty %}
                        <div class="p24 text-center" style="grid-column: 1 / -1;">
                            <p class="fs-body2 fc-medium">No tags found.</p>
                        </div>
                    {% endfor %}
                </div>
            </div>

             {# Pagination (Add if your view supports pagination) #}
            {% if All_tags.has_other_pages %}
            <div class="s-pagination site1 themed pager float-left mt24">
                 {% if All_tags.has_previous %}
                    <a class="s-pagination--item js-pagination-item" href="?page={{ All_tags.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" title="Go to previous page"> Prev </a>
                {% endif %}
                {% for i in All_tags.paginator.page_range %}
                    {% if All_tags.number == i %}
                        <span class="s-pagination--item is-selected">{{ i }}</span>
                    {% elif i > All_tags.number|add:'-3' and i < All_tags.number|add:'3' %} {# Show nearby pages #}
                        <a class="s-pagination--item js-pagination-item" href="?page={{ i }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" title="Go to page {{ i }}">{{ i }}</a>
                    {% elif i == All_tags.number|add:'-3' or i == All_tags.number|add:'3' %} {# Ellipsis #}
                         <span class="s-pagination--item s-pagination--item__clear">...</span>
                    {% endif %}
                {% endfor %}
                 {% if All_tags.has_next %}
                    <a class="s-pagination--item js-pagination-item" href="?page={{ All_tags.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" title="Go to next page"> Next </a>
                {% endif %}
            </div>
            {% endif %}


            <div class="ajax-failed-to-fetch-error"></div> {# For your AJAX search errors #}
        </div>
    </div>{# End #content #}

{% endblock content %} {# End the main content block #}

{% block js %} {# Start JS Block #}
<script>
    // Your existing AJAX search script
    $(document).ready(function() { // Wrap in document ready
        var token = '{{csrf_token}}';
        $('#id_search_user').on('input', function (e) {
            var searchTerm = $(this).val().toLowerCase(); // Get search term
            var $tagsList = $('#tags_list'); // Cache selector

            // Show loading state
            if (searchTerm.length > 0) {
                $tagsList.html(`<div class="d-flex jc-center p24" style="grid-column: 1 / -1;"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>`);
            } else {
                // If search is empty, show all tags (reload page)
                location.reload();
                return;
            }

            // --- AJAX Call START ---
            $.ajax({
                headers: { "X-CSRFToken": token },
                url: "{% url 'profile:Ajax_searchTag' %}", // Make sure this URL is correct
                data: { 'w': searchTerm }, // Use the captured search term
                method: 'get',
                dataType: 'json',
                success: function (response) {
                    $tagsList.empty();
                    if (response.results && response.results.length > 0) {
                        var tagsHtml = response.results.map(result => `
                            <div class="s-card js-tag-cell d-flex fd-column mySearchedTags" data-tag-name="${result.tag_name.toLowerCase()}">
                                <div class="d-flex jc-space-between ai-center mb12">
                                    <div class="flex--item d-flex ai-center gap-8">
                                        <span class="tag-icon" style="font-size: 24px;">${result.icon}</span>
                                        <a href="{% url 'tagbadge:taggedItemsFrom_All' 0 %}".replace('/0/', '/${result.id}/')
                                           class="post-tag" 
                                           style="background-color: ${result.color}15; border-color: ${result.color}50; color: ${result.color};"
                                           title="show questions tagged '${result.tag_name}'" 
                                           rel="tag">${result.tag_name}</a>
                                    </div>
                                </div>
                                <div class="flex--item fc-medium mb12 tag-description">
                                    ${result.description}
                                </div>
                                <div class="mt-auto d-flex jc-space-between fs-caption fc-black-400">
                                    <div class="flex--item">
                                        <strong>${result.question_count}</strong> question${result.question_count !== 1 ? 's' : ''}
                                    </div>
                                    <div class="flex--item s-anchors s-anchors__inherit"></div>
                                </div>
                            </div>
                        `).join("");
                        $tagsList.html(`<div id="tags-browser" class="d-grid g12 loopedTags">${tagsHtml}</div>`);
                    } else {
                        $tagsList.html('<div class="p24 text-center" style="grid-column: 1 / -1;"><p class="fs-body2 fc-medium">No tags found matching your filter.</p></div>');
                    }
                },
                error: function(xhr, status, error){
                     $tagsList.empty(); // Clear loader on error
                    $('.ajax-failed-to-fetch-error').html(`<div class="s-notice s-notice__danger p16 my16">Error loading tags. Please try again.</div>`);
                }
            });
             // --- AJAX Call END ---

        }); // End input event
    }); // End document ready
</script>
{% endblock js %} {# End JS Block #}
